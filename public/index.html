<!DOCTYPE html>
<html>
<head>
  <title>LAN Chat</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    #messages {
      border: 1px solid #ccc;
      height: 400px;
      overflow-y: auto;
      padding: 10px;
      margin-bottom: 10px;
      background-color: #f9f9f9;
    }
    #messages li {
      list-style: none;
      margin-bottom: 5px;
      padding: 5px;
      background-color: white;
      border-radius: 3px;
    }
    #input {
      width: 70%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 3px;
    }
    #sendBtn {
      width: 25%;
      padding: 10px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
    }
    #sendBtn:hover {
      background-color: #0056b3;
    }
    #users {
      border: 1px solid #ccc;
      padding: 10px;
      margin-top: 20px;
      background-color: #f0f0f0;
    }
    #users h3 {
      margin-top: 0;
    }
    #users ul {
      padding-left: 20px;
    }
    #status {
      margin-bottom: 10px;
      padding: 5px;
      border-radius: 3px;
    }
    .connected {
      background-color: #d4edda;
      color: #155724;
    }
    .disconnected {
      background-color: #f8d7da;
      color: #721c24;
    }
  </style>
</head>
<body>
  <h2>LAN Chat</h2>
  
  <div id="status" class="disconnected">Connecting...</div>
  
  <ul id="messages"></ul>
  
  <div>
    <input id="input" autocomplete="off" placeholder="Type your message here..." />
    <button id="sendBtn">Send</button>
  </div>
  
  <div id="users">
    <h3>Online Users (<span id="userCount">0</span>)</h3>
    <ul id="usersList"></ul>
  </div>

  <script>
    const ws = new WebSocket('ws://' + location.host);
    let myName = '';
    const statusDiv = document.getElementById('status');
    const messagesUl = document.getElementById('messages');
    const inputField = document.getElementById('input');
    const sendBtn = document.getElementById('sendBtn');

    ws.onopen = function() {
      statusDiv.textContent = 'Connected to chat server';
      statusDiv.className = 'connected';
    };

    ws.onclose = function() {
      statusDiv.textContent = 'Disconnected from server';
      statusDiv.className = 'disconnected';
    };

    ws.onerror = function(error) {
      statusDiv.textContent = 'Connection error';
      statusDiv.className = 'disconnected';
      console.error('WebSocket error:', error);
    };

    ws.onmessage = function(event) {
      let data = event.data;
      if (data instanceof Blob) {
        const reader = new FileReader();
        reader.onload = function() {
          handleMessage(reader.result);
        };
        reader.readAsText(data);
      } else {
        handleMessage(data);
      }
    };

    function handleMessage(data) {
      try {
        const msg = JSON.parse(data);
        if (msg.type === 'welcome') {
          myName = msg.name;
          appendMessage(`Welcome! You are ${msg.name}`, 'system');
        } else if (msg.type === 'users') {
          updateUserList(msg.users);
        } else if (msg.type === 'chat') {
          const isMyMessage = msg.name === myName;
          const timeStr = msg.timestamp ? ` [${msg.timestamp}]` : '';
          appendMessage(`${msg.name}: ${msg.message}${timeStr}`, isMyMessage ? 'own' : 'other');
        }
      } catch (error) {
        console.error('Error parsing message:', error);
        appendMessage(data, 'error');
      }
    }

    function appendMessage(msg, type = 'normal') {
      const li = document.createElement('li');
      li.textContent = msg;
      
      // Add styling based on message type
      if (type === 'system') {
        li.style.fontStyle = 'italic';
        li.style.color = '#666';
      } else if (type === 'own') {
        li.style.backgroundColor = '#e3f2fd';
        li.style.fontWeight = 'bold';
      } else if (type === 'error') {
        li.style.color = 'red';
      }
      
      messagesUl.appendChild(li);
      messagesUl.scrollTop = messagesUl.scrollHeight; // Auto-scroll to bottom
    }

    function updateUserList(users) {
      const usersUl = document.getElementById('usersList');
      const userCountSpan = document.getElementById('userCount');
      
      // Update user count
      userCountSpan.textContent = users.length;
      
      // Update user list
      usersUl.innerHTML = '';
      users.forEach(user => {
        const li = document.createElement('li');
        li.textContent = user + (user === myName ? ' (You)' : '');
        if (user === myName) {
          li.style.fontWeight = 'bold';
          li.style.color = '#007bff';
        }
        usersUl.appendChild(li);
      });
    }

    function sendMessage() {
      if (ws.readyState === WebSocket.OPEN) {
        const message = inputField.value.trim();
        if (message !== '') {
          console.log('Sending message:', message); // Debug log
          ws.send(message);
          inputField.value = '';
        }
      } else {
        appendMessage('Not connected to server', 'error');
      }
    }

    sendBtn.onclick = sendMessage;

    inputField.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        sendMessage();
      }
    });

    // Focus on input field when page loads
    window.onload = function() {
      inputField.focus();
    };
  </script>
</body>
</html>